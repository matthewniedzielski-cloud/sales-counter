
<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Raport Dzienny</title>
  <meta name="theme-color" content="#1a73e8">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <style>
    :root{
      --bg:#f7f7f8; --card:#ffffff; --text:#202124; --muted:#5f6368;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(rgba(26,115,232,0.06) 1px, transparent 1px) 0 0/22px 22px,
        radial-gradient(rgba(52,168,83,0.05) 1px, transparent 1px) 11px 11px/22px 22px,
        linear-gradient(#f7f7f8, #f7f7f8);
      color:var(--text);
    }
    .app{max-width:640px;margin:0 auto;min-height:100%;display:flex;flex-direction:column}
    header{position:sticky;top:0;background:var(--card);padding:14px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:10px;box-shadow:0 8px 20px rgba(0,0,0,.08);z-index:9999;}
    header h1{font-size:1.25rem;margin:0;font-weight:700;letter-spacing:.2px}
    .chip{margin-left:auto;display:flex;align-items:center;gap:8px;background:#eef3fd;color:#1a73e8;padding:8px 12px;font-weight:600; cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;padding:0}
    .card{cursor:pointer;background:var(--card);border:1px solid #eee;padding:16px;display:flex;flex-direction:column;gap:12px;aspect-ratio:1/1;justify-content:center;position:relative;min-width:0; }
    .product{display:flex;align-items:center;justify-content:center;width:100%;height:100%;text-align:center}
    .name{font-weight:700;font-size:1em;line-height:1.15 word-break:break-word; overflow-wrap:anywhere; max-width:100%; }
    .count{position:absolute;top:8px;right:10px;font-weight:800}
    .toolbar{position:sticky;bottom:0;background:var(--card);padding:12px 16px;border-top:1px solid #eee;display:flex;gap:10px;align-items:center;flex-wrap:wrap;box-shadow:0 -8px 20px rgba(0,0,0,.08)}
    .btn{border:none;padding:14px 16px;font-weight:700;cursor:pointer;background:#e0e0e0;color:var(--text)}
    .btn.primary{background:#1a73e8;color:#fff}
    .btn.secondary{background:#eef3fd;color:#1a73e8}
    .btn.warn{background:#fde9ea;color:#ea4335}
    .btn.ghost{background:#f6f6f7;color:var(--text)}
    .spacer{flex:1}
    .pill{padding:8px 12px;background:#f1f3f4;color:var(--muted);font-weight:600}
    dialog::backdrop{background:rgba(32,33,36,.45)}
    dialog{border:none;width:min(92vw,560px);padding:0}
    .sheet{padding:16px;background:#fff}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"], input[type="password"]{flex:1;border:1px solid #e0e0e0;padding:12px 14px;font-size:1rem}
    /* separate padding rules so color input has no padding */
    input[type="color"]{border:1px solid #e0e0e0;padding:0 !important;font-size:1rem;height:40px;width:44px}
    select{border:1px solid #e0e0e0;padding:10px 12px !important;font-size:1rem}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:12px;max-height:38vh;overflow:auto}
    .item{display:flex;align-items:center;gap:12px;border:1px solid #eee;padding:10px 12px;background:#fafafa}
    .item input{width:40%}
    .small{font-size:.85rem;color:var(--muted)}
    .footer{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid #eee;background:#fff}
    .hint{font-size:.9rem;color:var(--muted)}
    .badge{font-size:.8rem;font-weight:700;padding:4px 8px}
    .badge.add{background:#e6f4ea;color:#34a853}
    .badge.sub{background:#fde9ea;color:#ea4335}
    /* Hide export/import via CSS only */
    #exportBtn, label[for="importFile"] { display:none !important; }
    /* Toast */
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%) translateY(12px);
      background:#202124;color:#fff;padding:10px 14px;border-radius:0;
      box-shadow:0 8px 20px rgba(0,0,0,.18);opacity:0;pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;z-index:10000;}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
  
    .menu-btn{border:none;background:#f1f3f4;color:#202124;font-weight:800;padding:10px 12px;cursor:pointer}
    .menu-btn:active{transform:translateY(1px)}
    .menu-list{display:flex;flex-direction:column;gap:10px}
    .menu-list .btn{width:100%; text-align:left}

  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <button id="menuBtn" class="menu-btn" aria-label="Menu" title="Menu">☰</button>
      <h1>Raport Dzienny</h1>
      <span id="today" class="pill">--</span>
      <span class="chip" id="modeToggle" role="button" tabindex="0" title="Przytrzymaj, aby włączyć odejmowanie (PIN opcjonalny). Kliknij, aby wrócić do dodawania.">
        <span id="modeLabel">Tryb: Dodawanie</span>
      </span>
    </header>

    <main class="grid" id="grid"></main>
  </div>

  
  <!-- Navigation dialog (hamburger menu) -->
  <dialog id="navDlg">
    <form method="dialog">
      <div class="sheet">
        <h3 style="margin:6px 0 12px 0;">Menu</h3>
        <div class="menu-list">
          <button class="btn secondary" id="quickUndo" type="button">Cofnij</button>
          <button class="btn ghost" id="settingsBtn" type="button">Ustawienia</button>
          <button class="btn ghost" id="copyBtn" type="button">Kopiuj wyniki</button>
          <button class="btn secondary" id="installBtn" type="button">Zainstaluj</button>
          <label class="btn ghost" for="importFile" style="cursor:pointer">Import CSV</label>
          <input id="importFile" type="file" accept=".csv,text/csv" style="display:none">
          <button class="btn primary" id="resetDay" type="button">Nowy dzień</button>
        </div>
      </div>
      <div class="footer">
        <button class="btn primary" value="close">Zamknij</button>
      </div>
    </form>
  </dialog>

  <!-- Settings dialog -->
  <dialog id="settingsDlg">
    <form method="dialog">
      <div class="sheet">
        <h3 style="margin:6px 0 8px 0;">Produkty</h3>
        <div class="row">
          <input type="text" id="newName" placeholder="Nazwa produktu">
          <input type="color" id="newColor" value="#1a73e8" aria-label="Kolor">
          <button type="button" class="btn primary" id="addProduct">Dodaj</button>
        </div>

        <div class="list" id="productList"></div>

        <h3 style="margin:14px 0 6px 0;">Ustawienia</h3>
        <div class="row">
          <label class="small">Wersja aplikacji:</label>
          <span id="verSettings" class="pill">v?</span>
        </div>
        <div class="row">
          <label class="small">Imię i nazwisko:</label>
          <input type="text" id="empName" placeholder="np. Jan Kowalski">
        </div>
        <div class="row">
          <label class="small">PIN do odejmowania:</label>
          <input type="password" id="pin" placeholder="(opcjonalny)">
          <button type="button" class="btn secondary" id="savePin">Zapisz PIN</button>
        </div>
        <div class="row">
          <label class="small">Godzina resetu (admin):</label>
          <input type="time" id="resetTime" value="19:19" disabled>
          <button type="button" class="btn secondary" id="unlockReset">Odblokuj</button>
        </div>
        <div class="row">
          <label class="small">Format kopiowania:</label>
          <select id="smsFormatSelect">
            <option value="line">Jedna linia</option>
            <option value="multi">Wiele linii</option>
          </select>
        </div>

        <p class="hint">Zmiany zapisują się automatycznie (localStorage). Liczniki są dzienne (strefa czasowa: Europe/Warsaw).</p>
      </div>
      <div class="footer">
        <button class="btn ghost" id="settingsCancel" value="cancel">Anuluj</button>
        <button class="btn primary" id="settingsSave" type="button">Zapisz zmiany</button>
      </div>
    </form>
  </dialog>

  <!-- Install help dialog -->
  <dialog id="installHelpDlg">
    <form method="dialog">
      <div class="sheet">
        <h3 style="margin:6px 0 8px 0;">Jak zainstalować</h3>
        <ol style="margin:0 0 12px 18px; padding:0;">
          <li>W Chrome stuknij <b>⋮</b> w prawym górnym rogu.</li>
          <li>Wybierz <b>Zainstaluj aplikację</b> (albo <b>Dodaj do ekranu głównego</b>).</li>
          <li>Potwierdź. Ikona pojawi się na ekranie głównym.</li>
        </ol>
        <p class="small">Jeśli opcji nie ma, odśwież stronę po pierwszym wejściu (rejestruje się tryb offline) i spróbuj ponownie.</p>
      </div>
      <div class="footer">
        <button class="btn primary" value="ok">OK</button>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- jQuery CDN + lightweight fallback -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script>
    // Lightweight jQuery fallback (only features used in this app)
    (function(){
      if (window.jQuery) return; // CDN loaded
      function ready(fn){ if(document.readyState!='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
      function Dollar(sel){
        if (typeof sel === 'function'){ ready(sel); return; }
        if (sel === document || sel === window){ this.els = [sel]; return; }
        if (sel instanceof Element){ this.els = [sel]; return; }
        if (typeof sel === 'string'){
          const s = sel.trim();
          if (s.startsWith('<') && s.endsWith('>')){
            const t = document.createElement('template'); t.innerHTML = s;
            this.els = [t.content.firstElementChild];
            return;
          }
          this.els = Array.from(document.querySelectorAll(sel)); return;
        }
        this.els = [];
      }
      Dollar.prototype.text = function(v){ if(v===undefined) return this.els[0]?.textContent; this.els.forEach(e=>e.textContent=v); return this; };
      Dollar.prototype.val = function(v){ if(v===undefined) return this.els[0]?.value; this.els.forEach(e=>e.value=v); return this; };
      Dollar.prototype.empty = function(){ this.els.forEach(e=>e.innerHTML=''); return this; };
      Dollar.prototype.append = function(node){ this.els.forEach(e=> e.append(node instanceof Dollar? node.els[0] : node)); return this; };
      Dollar.prototype.closest = function(sel){ return new Dollar(this.els[0]?.closest(sel)); };
      Dollar.prototype.data = function(name, val){ const el=this.els[0]; const key=name.replace(/([A-Z])/g,'-$1').toLowerCase(); if(!el) return val===undefined?undefined:this; if(val===undefined) return el.dataset[name]||el.getAttribute('data-'+key); el.dataset[name]=val; return this; };
      Dollar.prototype.trigger = function(type){ this.els.forEach(e=> e.dispatchEvent(new Event(type,{bubbles:true}))); return this; };
      Dollar.prototype.toggleClass = function(cls, on){ const classes=cls.split(/\s+/).filter(Boolean); this.els.forEach(e=> classes.forEach(c=> on ? e.classList.add(c) : e.classList.remove(c))); return this; };
      Dollar.prototype.on = function(evt, sel, handler){
        if (typeof sel === 'function'){ handler = sel; sel = null; }
        this.els.forEach(el => {
          el.addEventListener(evt, function(e){
            if (!sel){ handler.call(e.target, e); return; }
            const match = e.target.closest(sel);
            if (match && el.contains(match)){ handler.call(match, e); }
          });
        });
        return this;
      };
      function $(sel){ return new Dollar(sel); }
      $.fn = Dollar.prototype;
      window.$ = window.jQuery = $;
    })();
  </script>

  <script>
    const APP_VERSION = '1.0.4';

    // --- Keys ---
    const LS_PRODUCTS = 'sc_products_v1';
    const LS_PIN = 'sc_pin_v1';
    const LS_AUTORESET = 'sc_auto_reset_v1';
    const LS_RESET_TIME = 'sc_reset_time_v1';
    const LS_EMP = 'sc_emp_v1';
    const LS_SMSFMT = 'sc_smsfmt_v1';
    const countsKey = (dateStr) => 'sc_counts_' + (dateStr || warsawISO());

    // --- Utils ---
    function contrastColor(hex){
      try{
        const c = hex.replace('#','');
        const r = parseInt(c.substring(0,2),16);
        const g = parseInt(c.substring(2,4),16);
        const b = parseInt(c.substring(4,6),16);
        const lum = 0.2126*(r/255) + 0.7152*(g/255) + 0.0722*(b/255);
        return lum > 0.6 ? '#202124' : '#ffffff';
      }catch(e){ return '#202124'; }
    }

    // Time helpers (Europe/Warsaw)
    function warsawParts(){
      const tz = 'Europe/Warsaw';
      const d = new Date();
      const date = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);
      const time = new Intl.DateTimeFormat('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).formatToParts(d);
      const y = +date.find(p=>p.type==='year').value;
      const m = +date.find(p=>p.type==='month').value;
      const dd = +date.find(p=>p.type==='day').value;
      const hh = +time.find(p=>p.type==='hour').value;
      const mi = +time.find(p=>p.type==='minute').value;
      const ss = +time.find(p=>p.type==='second').value;
      return {y,m,dd,hh,mi,ss};
    }
    function warsawISO(){ const {y,m,dd}=warsawParts(); const mm=(''+m).padStart(2,'0'); const d=(''+dd).padStart(2,'0'); return `${y}-${mm}-${d}`; }
    function warsawDateLabel(){ return new Intl.DateTimeFormat('pl-PL',{timeZone:'Europe/Warsaw'}).format(new Date()); }

    // --- Data ---
    function loadProducts(){
      const raw = localStorage.getItem(LS_PRODUCTS);
      if(raw){ try { return JSON.parse(raw); } catch(e){} }
      const demo = [
        {id: crypto.randomUUID(), name:'Produkt A', color:'#1a73e8'},
        {id: crypto.randomUUID(), name:'Produkt B', color:'#34a853'},
        {id: crypto.randomUUID(), name:'Produkt C', color:'#ea4335'},
        {id: crypto.randomUUID(), name:'Produkt D', color:'#fbbc05'}
      ];
      localStorage.setItem(LS_PRODUCTS, JSON.stringify(demo));
      return demo;
    }
    function saveProducts(list){ localStorage.setItem(LS_PRODUCTS, JSON.stringify(list)); }

    function loadCounts(dateStr){
      const raw = localStorage.getItem(countsKey(dateStr));
      return raw ? JSON.parse(raw) : {};
    }
    function saveCounts(map){ localStorage.setItem(countsKey(), JSON.stringify(map)); }

    // --- UI ---
    let mode = 'add'; // 'add' | 'sub'
    let lastAction = null;
    const holdMs = 1000;
    let holdTimer = null;

    function renderGrid(){
      const products = loadProducts();
      const counts = loadCounts();
      const $grid = $('#grid').empty();
      products.forEach(p => {
        const count = counts[p.id] || 0;
        const fg = contrastColor(p.color);
        const $card = $(`
          <div class="card product-card" data-id="${p.id}" style="background:${p.color}; color:${fg}">
            <div class="product" aria-label="${p.name}">
              <div class="name">${p.name}</div>
              <div class="count" id="count-${p.id}">${count}</div>
            </div>
          </div>
        `);
        $grid.append($card);
      });
    }

    function renderSettings(){
      const products = loadProducts();
      const $list = $('#productList').empty();
      products.forEach((p, idx) => {
        const $row = $(`
          <div class="item" data-id="${p.id}">
            <span class="badge add">#${idx+1}</span>
            <input class="p-name" type="text" value="${p.name}" aria-label="Nazwa">
            <input class="p-color" type="color" value="${p.color}" title="Kolor">
            <button class="btn warn p-del">Usuń</button>
          </div>
        `);
        $list.append($row);
      });
      // preload settings values
      $('#empName').val(localStorage.getItem(LS_EMP) || '');
      $('#smsFormatSelect').val(localStorage.getItem(LS_SMSFMT) || 'line');
      $('#resetTime').val(localStorage.getItem(LS_RESET_TIME) || '19:19').prop('disabled', true);
    }

    function updateModeUI(){
      $('#modeLabel').text(mode === 'add' ? 'Tryb: Dodawanie' : 'Tryb: Odejmowanie')
        .toggleClass('badge add', mode==='add').toggleClass('badge sub', mode==='sub');
    }

    function bump(id){
      const counts = loadCounts();
      const curr = counts[id] || 0;
      const delta = (mode === 'add') ? 1 : -1;
      const next = Math.max(0, curr + delta);
      counts[id] = next;
      saveCounts(counts);
      $('#count-'+id).text(next);
      lastAction = {id, delta: (next===curr?0:delta)};
    }
    function undo(){
      if(!lastAction || lastAction.delta === 0) return;
      const counts = loadCounts();
      const curr = counts[lastAction.id] || 0;
      const next = Math.max(0, curr - lastAction.delta);
      counts[lastAction.id] = next;
      saveCounts(counts);
      $('#count-'+lastAction.id).text(next);
      lastAction = null;
    }

    // Copy for SMS
    function formatTodayCounts(){
      const products = loadProducts();
      const counts = loadCounts();
      const dateLocal = warsawDateLabel();
      const parts = products.map(p => `${p.name}: ${counts[p.id] || 0}`);
      const emp = (localStorage.getItem(LS_EMP) || '').trim();
      const who = emp ? ` (${emp})` : '';
      const header = `Wyniki ${dateLocal}${who}:`;
      const fmt = localStorage.getItem(LS_SMSFMT) || 'line';
      if(fmt === 'multi'){
        const NL = String.fromCharCode(10);
        return [header, ...parts].join(NL);
      } else {
        return `${header} ${parts.join(', ')}`;
      }
    }
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        showToast('Skopiowano wyniki do schowka.');
      }catch(e){
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); showToast('Skopiowano wyniki do schowka.'); }
        catch(err){ alert('Nie udało się skopiować.'); }
        finally{ document.body.removeChild(ta); }
      }
    }

    // Toast
    function showToast(msg){
      var el = document.getElementById('toast');
      if(!el) return;
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(function(){ el.classList.remove('show'); }, 1800);
    }

    // Auto reset watcher (Europe/Warsaw), using stamp "YYYY-MM-DD HH:MM"
    function startAutoResetWatcher(){
      function tick(){
        try{
          const p = warsawParts();
          const rt = (localStorage.getItem(LS_RESET_TIME) || '19:19').split(':');
          const trgH = parseInt(rt[0],10)||19;
          const trgM = parseInt(rt[1],10)||19;
          const stamp = warsawISO() + ' ' + String(trgH).padStart(2,'0') + ':' + String(trgM).padStart(2,'0');
          const last = localStorage.getItem(LS_AUTORESET) || '';
          if(p.hh===trgH && p.mi===trgM && last !== stamp){
            localStorage.setItem(LS_AUTORESET, stamp);
            saveCounts({});
            $('#today').text(warsawDateLabel());
            renderGrid();
            showToast('Automatyczne czyszczenie danych (' + String(trgH).padStart(2,'0') + ':' + String(trgM).padStart(2,'0') + ')');
          }
        }catch(e){ /* ignore */ }
      }
      tick();
      window.__resetTimer = setInterval(tick, 10*1000);
    }

    // --- PWA Install ---
    let __deferredPrompt = null;
    function isStandalone(){
      return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true);
    }
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      __deferredPrompt = e;
      $('#installBtn').show();
    });
    window.addEventListener('appinstalled', () => {
      __deferredPrompt = null;
      $('#installBtn').hide();
      showToast('Zainstalowano aplikację');
    });

    // --- Events ---
    $(function(){
      // init
      $('#today').text(warsawDateLabel());
      $('#verSettings').text(APP_VERSION);
      renderGrid();
      startAutoResetWatcher();
      updateModeUI();
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
      if(isStandalone()){ $('#installBtn').hide(); }

      // mode toggle on chip (hold to enable subtract)
      $(document).on('mousedown touchstart', '#modeToggle', function(){
        if(mode === 'sub'){ mode = 'add'; updateModeUI(); return; }
        holdTimer = setTimeout(()=>{
          const saved = localStorage.getItem(LS_PIN) || '';
          if(!saved || prompt('Podaj PIN, aby włączyć odejmowanie:') === saved){ mode='sub'; updateModeUI(); }
          else { alert('Nieprawidłowy PIN.'); }
        }, 1000);
      }).on('mouseup mouseleave touchend touchcancel', '#modeToggle', function(){ clearTimeout(holdTimer); });

      // keyboard access for chip
      $(document).on('keydown', '#modeToggle', function(e){
        if(e.key === 'Enter'){ if(mode === 'sub'){ mode='add'; updateModeUI(); } }
        if(e.key === ' '){ e.preventDefault(); const ev = new Event('mousedown'); this.dispatchEvent(ev); }
      });

      // product tap
      $(document).on('click', '.product-card', function(){ const id = $(this).data('id'); bump(id); });
      // undo
      $(document).on('click', '#quickUndo', undo);

      $(document).on('click', '#menuBtn', function(){ document.getElementById('navDlg').showModal(); });

      // settings open
      $(document).on('click', '#settingsBtn', function(){
        renderSettings();
        $('#pin').val('');
        document.getElementById('settingsDlg').showModal();
      });

      // settings save / cancel
      $(document).on('click', '#settingsSave', function(){ document.getElementById('settingsDlg').close(); showToast('Zapisano zmiany'); });
      // add product
      $(document).on('click', '#addProduct', function(){
        const name = $('#newName').val().trim();
        const color = $('#newColor').val();
        if(!name){ alert('Podaj nazwę produktu.'); return; }
        const products = loadProducts();
        products.push({id: crypto.randomUUID(), name, color});
        saveProducts(products);
        $('#newName').val('');
        renderSettings();
        renderGrid();
      });
      $(document).on('keydown', '#newName', function(e){ if(e.key === 'Enter'){ e.preventDefault(); $('#addProduct').trigger('click'); } });

      // edit/delete product
      $(document).on('input', '.item .p-name', function(){
        const id = $(this).closest('.item').data('id');
        const products = loadProducts();
        const p = products.find(x => x.id === id);
        if(p){ p.name = this.value; saveProducts(products); renderGrid(); }
      });
      $(document).on('input', '.item .p-color', function(){
        const id = $(this).closest('.item').data('id');
        const products = loadProducts();
        const p = products.find(x => x.id === id);
        if(p){ p.color = this.value; saveProducts(products); renderGrid(); }
      });
      $(document).on('click', '.item .p-del', function(){
        const id = $(this).closest('.item').data('id');
        const products = loadProducts().filter(x => x.id !== id);
        saveProducts(products); renderSettings(); renderGrid();
      });

      // pin save
      $(document).on('click', '#savePin', function(){
        const v = $('#pin').val(); if(v && v.length < 4){ alert('PIN min. 4 znaki.'); return; }
        localStorage.setItem(LS_PIN, v || ''); showToast(v ? 'PIN zapisany.' : 'PIN usunięty.');
      });

      // admin unlock reset time
      $(document).on('click', '#unlockReset', function(){
        const p = prompt('Podaj PIN administratora, aby zmienić godzinę resetu:');
        if(p === '9797'){ $('#resetTime').prop('disabled', false); showToast('Tryb admina odblokowany.'); }
        else if(p !== null){ alert('Nieprawidłowy PIN.'); }
      });
      $(document).on('change', '#resetTime', function(){
        const v = (this.value || '').trim();
        const ok = /^([01]\d|2[0-3]):([0-5]\d)$/.test(v);
        if(!ok){ alert('Podaj godzinę w formacie HH:MM (00-23 : 00-59).'); return; }
        localStorage.setItem(LS_RESET_TIME, v);
        showToast('Godzina resetu: ' + v);
      });

      // SMS format
      $(document).on('change', '#smsFormatSelect', function(){ localStorage.setItem(LS_SMSFMT, this.value); });

      // copy
      $(document).on('click', '#copyBtn', function(){ copyText(formatTodayCounts()); });

      // export/import (kept but hidden)
      $(document).on('click', '#exportBtn', function(){ if(confirm('Eksportować WSZYSTKIE dni do CSV? (OK=wszystkie, Anuluj=tylko dziś)')) exportCSV(true); else exportCSV(false); });
      $(document).on('change', '#importFile', function(){ if(this.files && this.files[0]) importCSV(this.files[0]); this.value=''; });

      // install button
      $(document).on('click', '#installBtn', async function(){
        if(isStandalone()){ $(this).hide(); return; }
        if(!__deferredPrompt){ document.getElementById('installHelpDlg').showModal(); return; }
        __deferredPrompt.prompt();
        try{
          const choice = await __deferredPrompt.userChoice;
          if(choice && choice.outcome === 'accepted'){ showToast('Instalacja rozpoczęta'); }
          else { showToast('Instalacja anulowana'); }
        } catch(err){}
        __deferredPrompt = null;
        $('#installBtn').hide();
      });

      // reset day button (manual)
      $(document).on('click', '#resetDay', function(){
        if(confirm('Rozpocząć nowy dzień? Bieżące liczniki zostaną wyzerowane (archiwum pozostanie pod poprzednią datą).')){
          $('#today').text(warsawDateLabel());
          saveCounts({});
          renderGrid();
        }
      });
    });

    // Export/Import helpers (kept for completeness)
    function exportCSV(all=false){
      const products = loadProducts();
      const pMap = Object.fromEntries(products.map(p=>[p.id,p]));
      const rows = [];
      const d = warsawISO();
      const dates = all ? Object.keys(localStorage).filter(k=>k.startsWith('sc_counts_')).map(k=>k.replace('sc_counts_','')).sort().reverse().slice().reverse() : [d];
      dates.forEach(date => {
        const c = loadCounts(date);
        Object.keys(c).forEach(id => {
          const p = pMap[id] || {name:'(usunięty)'};
          rows.push([date, p.name, c[id]]);
        });
      });
      const header = "date,product,count\n";
      const body = rows.map(r => r.map(x => (''+x).replaceAll('"','""')).join(',')).join('\n');
      const blob = new Blob([header+body], {type: 'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const ver = (typeof APP_VERSION!=='undefined' ? APP_VERSION : '');
      const base = all ? `sales_all_v${ver}` : `sales_${d}_v${ver}`;
      a.download = base + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function importCSV(file){
      const reader = new FileReader();
      reader.onload = () => {
        const text = reader.result;
        const lines = text.trim().split(/\r?\n/);
        const products = loadProducts();
        let counts = loadCounts();
        lines.slice(1).forEach(line => {
          const parts = line.split(',');
          if(parts.length < 3) return;
          const name = parts[1].trim().replace(/^"|"$/g,'');
          const cnt = Math.max(0, parseInt(parts[2],10)||0);
          let p = products.find(x => x.name.toLowerCase() === name.toLowerCase());
          if(!p){
            p = {id: crypto.randomUUID(), name, color:'#9AA0A6'};
            products.push(p);
          }
          counts[p.id] = cnt;
        });
        saveProducts(products);
        saveCounts(counts);
        renderSettings();
        renderGrid();
        alert('Import zakończony.');
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
