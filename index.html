
<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Sales Counter</title>
  <meta name="theme-color" content="#1a73e8">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <style>
    :root{
      --bg:#f7f7f8; --card:#ffffff; --text:#202124; --muted:#5f6368;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .app{max-width:540px;margin:0 auto;min-height:100%;display:flex;flex-direction:column}
    header{position:sticky;top:0;background:var(--card);padding:14px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:10px}
    header h1{font-size:1.25rem;margin:0;font-weight:700;letter-spacing:.2px}
    .chip{margin-left:auto;display:flex;align-items:center;gap:8px;background:#eef3fd;color:#1a73e8;padding:8px 12px;font-weight:600}
    .chip button{all:unset;cursor:pointer;padding:2px 6px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:0}
    @media (max-width: 480px){ .grid{grid-template-columns:1fr} }
    .card{cursor:pointer;background:var(--card);border:1px solid #eee;padding:16px;display:flex;flex-direction:column;gap:12px;aspect-ratio:1/1;justify-content:center}
    .product{display:flex;align-items:center;gap:12px;font-size:1.05rem}
    .name{font-weight:700}
    .count{margin-left:auto;font-weight:800}
    .toolbar{position:sticky;bottom:0;background:var(--card);padding:12px 16px;border-top:1px solid #eee;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:none;padding:14px 16px;font-weight:700;cursor:pointer;background:#e0e0e0;color:var(--text)}
    .btn.primary{background:#1a73e8;color:#fff}
    .btn.secondary{background:#eef3fd;color:#1a73e8}
    .btn.warn{background:#fde9ea;color:#ea4335}
    .btn.ghost{background:#f6f6f7;color:var(--text)}
    .spacer{flex:1}
    .pill{padding:8px 12px;background:#f1f3f4;color:var(--muted);font-weight:600}
    dialog::backdrop{background:rgba(32,33,36,.45)}
    dialog{border:none;width:min(92vw,560px);padding:0}
    .sheet{padding:16px;background:#fff}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"], input[type="password"]{flex:1;border:1px solid #e0e0e0;padding:12px 14px;font-size:1rem}
    input[type="color"], select{border:1px solid #e0e0e0;padding:10px 12px;font-size:1rem}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:12px;max-height:38vh;overflow:auto}
    .item{display:flex;align-items:center;gap:12px;border:1px solid #eee;padding:10px 12px;background:#fafafa}
    .item input{width:40%}
    .small{font-size:.85rem;color:var(--muted)}
    .footer{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid #eee;background:#fff}
    .hint{font-size:.9rem;color:var(--muted)}
    .badge{font-size:.8rem;font-weight:700;padding:4px 8px}
    .badge.add{background:#e6f4ea;color:#34a853}
    .badge.sub{background:#fde9ea;color:#ea4335}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>Sales Counter</h1>
      <span id="today" class="pill">--</span>
      <span class="chip">
        <span id="modeLabel">Tryb: Dodawanie</span>
        <button id="toggleMode" title="Przełącz tryb (odejmowanie wymaga PIN + przytrzymanie)">➕/➖</button>
      </span>
    </header>

    <main class="grid" id="grid"></main>

    <section class="toolbar">
      <div class="tools">
        <button class="btn secondary" id="quickUndo">Cofnij</button>
        <button class="btn ghost" id="settingsBtn">Ustawienia</button>
        <button class="btn ghost" id="historyBtn">Historia</button>
        <button class="btn ghost" id="exportBtn">Eksport CSV</button>
        <label class="btn ghost" for="importFile" style="cursor:pointer">Import CSV</label>
        <input id="importFile" type="file" accept=".csv,text/csv" style="display:none">
      </div>
      <span class="spacer"></span>
      <button class="btn primary" id="resetDay">Nowy dzień</button>
    </section>
  </div>

  <!-- Settings dialog -->
  <dialog id="settingsDlg">
    <form method="dialog">
      <div class="sheet">
        <h3 style="margin:6px 0 8px 0;">Produkty</h3>
        <div class="row">
          <input type="text" id="newName" placeholder="Nazwa produktu">
          <input type="color" id="newColor" value="#1a73e8" aria-label="Kolor">
          <button type="button" class="btn primary" id="addProduct">Dodaj</button>
        </div>

        <div class="list" id="productList"></div>

        <h3 style="margin:14px 0 6px 0;">Ustawienia</h3>
        <div class="row">
          <label class="small">Wersja aplikacji:</label>
          <span id="verSettings" class="pill">v?</span>
        </div>
        <div class="row">
          <label class="small">PIN do odejmowania:</label>
          <input type="password" id="pin" placeholder="(opcjonalny)">
          <button type="button" class="btn secondary" id="savePin">Zapisz PIN</button>
        </div>
        <div class="row">
          <label class="small">Duże kafelki:</label>
          <button type="button" class="btn ghost" id="toggleSize">Przełącz</button>
          <span class="small" id="sizeState"></span>
        </div>

        <p class="hint">Zmiany zapisują się automatycznie (localStorage). Liczniki są dzienne.</p>
      </div>
      <div class="footer">
        <button class="btn ghost" value="cancel">Zamknij</button>
      </div>
    </form>
  </dialog>

  <!-- History dialog -->
  <dialog id="historyDlg">
    <form method="dialog">
      <div class="sheet">
        <h3 style="margin:6px 0 8px 0;">Historia dni</h3>
        <div id="historyList" class="list"></div>
      </div>
      <div class="footer">
        <button class="btn ghost" value="cancel">Zamknij</button>
      </div>
    </form>
  </dialog>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script>
    const APP_VERSION = 'v2-r14';

    // --- Keys ---
    const LS_PRODUCTS = 'sc_products_v1';
    const LS_PIN = 'sc_pin_v1';
    const LS_SIZE = 'sc_large_tiles_v1';
    const countsKey = (dateStr) => 'sc_counts_' + (dateStr || new Date().toISOString().slice(0,10));

    // --- Utils ---
    function contrastColor(hex){
      try{
        const c = hex.replace('#','');
        const r = parseInt(c.substring(0,2),16);
        const g = parseInt(c.substring(2,4),16);
        const b = parseInt(c.substring(4,6),16);
        const lum = 0.2126*(r/255) + 0.7152*(g/255) + 0.0722*(b/255);
        return lum > 0.6 ? '#202124' : '#ffffff';
      }catch(e){ return '#202124'; }
    }

    // --- Data ---
    function loadProducts(){
      const raw = localStorage.getItem(LS_PRODUCTS);
      if(raw){ try { return JSON.parse(raw); } catch(e){} }
      const demo = [
        {id: crypto.randomUUID(), name:'Produkt A', color:'#1a73e8'},
        {id: crypto.randomUUID(), name:'Produkt B', color:'#34a853'},
        {id: crypto.randomUUID(), name:'Produkt C', color:'#ea4335'},
        {id: crypto.randomUUID(), name:'Produkt D', color:'#fbbc05'}
      ];
      localStorage.setItem(LS_PRODUCTS, JSON.stringify(demo));
      return demo;
    }
    function saveProducts(list){ localStorage.setItem(LS_PRODUCTS, JSON.stringify(list)); }

    function loadCounts(dateStr){
      const raw = localStorage.getItem(countsKey(dateStr));
      return raw ? JSON.parse(raw) : {};
    }
    function saveCounts(map){ localStorage.setItem(countsKey(), JSON.stringify(map)); }

    function allDates(){
      return Object.keys(localStorage).filter(k => k.startsWith('sc_counts_')).map(k => k.replace('sc_counts_','')).sort().reverse();
    }

    // --- UI ---
    let mode = 'add'; // 'add' | 'sub'
    let lastAction = null;
    const holdMs = 1000;
    let holdTimer = null;

    function renderGrid(){
      const products = loadProducts();
      const counts = loadCounts();
      const $grid = $('#grid').empty();
      products.forEach(p => {
        const count = counts[p.id] || 0;
        const fg = contrastColor(p.color);
        const $card = $(`
          <div class="card product-card" data-id="${p.id}" style="background:${p.color}; color:${fg}">
            <div class="product" aria-label="${p.name}">
              <div class="name">${p.name}</div>
              <div class="count" id="count-${p.id}">${count}</div>
            </div>
          </div>
        `);
        $grid.append($card);
      });
    }

    function renderSettings(){
      const products = loadProducts();
      const $list = $('#productList').empty();
      products.forEach((p, idx) => {
        const $row = $(`
          <div class="item" data-id="${p.id}">
            <span class="badge add">#${idx+1}</span>
            <input class="p-name" type="text" value="${p.name}" aria-label="Nazwa">
            <input class="p-color" type="color" value="${p.color}" title="Kolor">
            <button class="btn warn p-del">Usuń</button>
          </div>
        `);
        $list.append($row);
      });
      $('#sizeState').text(localStorage.getItem(LS_SIZE)==='1' ? 'Włączone' : 'Wyłączone');
    }

    function updateModeUI(){
      $('#modeLabel').text(mode === 'add' ? 'Tryb: Dodawanie' : 'Tryb: Odejmowanie')
        .toggleClass('badge add', mode==='add').toggleClass('badge sub', mode==='sub');
    }

    function bump(id){
      const counts = loadCounts();
      const curr = counts[id] || 0;
      const delta = (mode === 'add') ? 1 : -1;
      const next = Math.max(0, curr + delta);
      counts[id] = next;
      saveCounts(counts);
      $('#count-'+id).text(next);
      lastAction = {id, delta: (next===curr?0:delta)};
    }
    function undo(){
      if(!lastAction || lastAction.delta === 0) return;
      const counts = loadCounts();
      const curr = counts[lastAction.id] || 0;
      const next = Math.max(0, curr - lastAction.delta);
      counts[lastAction.id] = next;
      saveCounts(counts);
      $('#count-'+lastAction.id).text(next);
      lastAction = null;
    }

    function exportCSV(all=false){
      const products = loadProducts();
      const pMap = Object.fromEntries(products.map(p=>[p.id,p]));
      const rows = [];
      const dates = all ? allDates().slice().reverse() : [new Date().toISOString().slice(0,10)];
      dates.forEach(d => {
        const c = loadCounts(d);
        Object.keys(c).forEach(id => {
          const p = pMap[id] || {name:'(usunięty)'};
          rows.push([d, p.name, c[id]]);
        });
      });
      const header = "date,product,count\n";
      const body = rows.map(r => r.map(x => (''+x).replaceAll('"','""')).join(',')).join('\n');
      const blob = new Blob([header+body], {type: 'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (all?'sales_all':'sales_'+dates[0]) + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importCSV(file){
      const reader = new FileReader();
      reader.onload = () => {
        const text = reader.result;
        const lines = text.trim().split(/\r?\n/);
        const products = loadProducts();
        let counts = loadCounts();
        lines.slice(1).forEach(line => {
          const parts = line.split(',');
          if(parts.length < 3) return;
          const name = parts[1].trim().replace(/^"|"$/g,'');
          const cnt = Math.max(0, parseInt(parts[2],10)||0);
          let p = products.find(x => x.name.toLowerCase() === name.toLowerCase());
          if(!p){
            p = {id: crypto.randomUUID(), name, color:'#9AA0A6'};
            products.push(p);
          }
          counts[p.id] = cnt;
        });
        saveProducts(products);
        saveCounts(counts);
        renderSettings();
        renderGrid();
        alert('Import zakończony.');
      };
      reader.readAsText(file);
    }

    function renderHistory(){
      const dates = allDates();
      const $list = $('#historyList').empty();
      const products = loadProducts();
      const pMap = Object.fromEntries(products.map(p=>[p.id,p]));
      dates.forEach(d => {
        const map = loadCounts(d);
        const sum = Object.values(map).reduce((a,b)=>a+(b||0),0);
        const $row = $(`
          <div class="item">
            <span class="badge">📅 ${d}</span>
            <span class="small">Razem: <b>${sum}</b></span>
            <span class="spacer"></span>
            <button class="btn ghost exp-date" data-date="${d}">Eksportuj</button>
          </div>
        `);
        $list.append($row);
        Object.keys(map).forEach(id => {
          const p = pMap[id] || {name:'(usunięty)', color:'#9AA0A6'};
          const $d = $(`
            <div class="item" style="margin-left:18px;">
              <span>${p.name}</span>
              <span class="count" style="margin-left:auto">${map[id]}</span>
            </div>
          `);
          $list.append($d);
        });
      });
    }

    function requestPinOk(){
      const saved = localStorage.getItem(LS_PIN) || '';
      if(!saved) return true;
      const entered = prompt('Podaj PIN, aby włączyć odejmowanie:');
      return entered === saved;
    }

    function applySize(){
      const large = localStorage.getItem(LS_SIZE)==='1';
      document.getElementById('app').classList.toggle('lg', large);
    }

    // --- Events ---
    $(function(){
      // init
      $('#today').text(new Date().toLocaleDateString());
      $('#verSettings').text(APP_VERSION);
      applySize();
      renderGrid();
      updateModeUI();
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }

      // mode toggle (hold to enable subtract)
      $(document).on('mousedown touchstart', '#toggleMode', function(){
        if(mode === 'sub'){ mode = 'add'; updateModeUI(); return; }
        holdTimer = setTimeout(()=>{
          if(requestPinOk()){ mode='sub'; updateModeUI(); }
          else { alert('Nieprawidłowy PIN.'); }
        }, holdMs);
      }).on('mouseup mouseleave touchend touchcancel', '#toggleMode', function(){ clearTimeout(holdTimer); });

      // product tap
      $(document).on('click', '.product-card', function(){
        const id = $(this).data('id');
        bump(id);
      });

      // undo
      $(document).on('click', '#quickUndo', undo);

      // settings open
      $(document).on('click', '#settingsBtn', function(){
        renderSettings();
        $('#pin').val('');
        document.getElementById('settingsDlg').showModal();
      });

      // add product
      $(document).on('click', '#addProduct', function(){
        const name = $('#newName').val().trim();
        const color = $('#newColor').val();
        if(!name){ alert('Podaj nazwę produktu.'); return; }
        const products = loadProducts();
        products.push({id: crypto.randomUUID(), name, color});
        saveProducts(products);
        $('#newName').val('');
        renderSettings();
        renderGrid();
      });
      $(document).on('keydown', '#newName', function(e){
        if(e.key === 'Enter'){ e.preventDefault(); $('#addProduct').trigger('click'); }
      });

      // edit/delete product (delegated)
      $(document).on('input', '.item .p-name', function(){
        const id = $(this).closest('.item').data('id');
        const products = loadProducts();
        const p = products.find(x => x.id === id);
        if(p){ p.name = this.value; saveProducts(products); renderGrid(); }
      });
      $(document).on('input', '.item .p-color', function(){
        const id = $(this).closest('.item').data('id');
        const products = loadProducts();
        const p = products.find(x => x.id === id);
        if(p){ p.color = this.value; saveProducts(products); renderGrid(); }
      });
      $(document).on('click', '.item .p-del', function(){
        const id = $(this).closest('.item').data('id');
        const products = loadProducts().filter(x => x.id !== id);
        saveProducts(products); renderSettings(); renderGrid();
      });

      // pin save
      $(document).on('click', '#savePin', function(){
        const v = $('#pin').val(); if(v && v.length < 4){ alert('PIN min. 4 znaki.'); return; }
        localStorage.setItem(LS_PIN, v || ''); alert(v ? 'PIN zapisany.' : 'PIN usunięty.');
      });

      // large tiles toggle
      $(document).on('click', '#toggleSize', function(){
        const curr = localStorage.getItem(LS_SIZE)==='1';
        localStorage.setItem(LS_SIZE, curr ? '0' : '1'); applySize();
        $('#sizeState').text(!curr ? 'Włączone' : 'Wyłączone');
      });

      // history
      $(document).on('click', '#historyBtn', function(){ renderHistory(); document.getElementById('historyDlg').showModal(); });
      $(document).on('click', '.exp-date', function(){
        const d = $(this).data('date');
        const products = loadProducts();
        const pMap = Object.fromEntries(products.map(p=>[p.id,p]));
        const c = loadCounts(d);
        const rows = [];
        Object.keys(c).forEach(id => {
          const p = pMap[id] || {name:'(usunięty)'};
          rows.push([d, p.name, c[id]]);
        });
        const header = "date,product,count\n";
        const body = rows.map(r => r.map(x => (''+x).replaceAll('"','""')).join(',')).join('\n');
        const blob = new Blob([header+body], {type: 'text/csv;charset=utf-8;'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sales_'+d+'.csv'; a.click(); URL.revokeObjectURL(a.href);
      });

      // export/import
      $(document).on('click', '#exportBtn', function(){ if(confirm('Eksportować WSZYSTKIE dni do CSV? (OK=wszystkie, Anuluj=tylko dziś)')) exportCSV(true); else exportCSV(false); });
      $(document).on('change', '#importFile', function(){ if(this.files && this.files[0]) importCSV(this.files[0]); this.value=''; });

      // reset day
      $(document).on('click', '#resetDay', function(){
        if(confirm('Rozpocząć nowy dzień? Bieżące liczniki zostaną wyzerowane (archiwum pozostanie pod poprzednią datą).')){
          localStorage.setItem('sc_last_reset', new Date().toISOString());
          $('#today').text(new Date().toLocaleDateString());
          renderGrid();
        }
      });
    });
  </script>
</body>
</html>
